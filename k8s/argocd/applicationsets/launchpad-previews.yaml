# Argo CD ApplicationSet for Preview Environments
# Automatically creates/deletes Applications based on PRs with "deploy" label

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: launchpad-previews
  namespace: argocd
spec:
  # Pull Request generator - watches GitHub PRs
  generators:
    - pullRequest:
        github:
          # GitHub repository info
          owner: '{{GITHUB_ORG}}'
          repo: '{{GITHUB_REPO}}'
          # GitHub token for API access (read-only)
          tokenRef:
            secretName: github-token
            key: token
          # Only PRs with "deploy" label
          labels:
            - deploy
        # How often to check for PR changes (seconds)
        requeueAfterSeconds: 180 # 3 minutes

  # Template for creating Applications
  template:
    metadata:
      name: 'launchpad-pr-{{number}}'
      # Automatically delete Application when PR is closed or label removed
      finalizers:
        - resources-finalizer.argocd.argoproj.io
      labels:
        app.kubernetes.io/name: launchpad-preview
        app.kubernetes.io/instance: 'pr-{{number}}'
        preview: 'true'
      annotations:
        # Link to PR
        link: '{{url}}'
        # PR metadata
        pr-number: '{{number}}'
        pr-title: '{{title}}'
        pr-author: '{{author}}'
        pr-branch: '{{branch}}'

    spec:
      # Use development project
      project: launchpad-development

      # Source - PR branch
      source:
        repoURL: 'https://github.com/{{GITHUB_ORG}}/{{GITHUB_REPO}}'
        # Use PR's head commit
        targetRevision: '{{head_sha}}'
        path: k8s/helm/launchpad

        helm:
          valueFiles:
            - values-development.yaml

          parameters:
            # Image repository (dynamic)
            - name: imageDefaults.organization
              value: '{{GITHUB_ORG}}'
            - name: imageDefaults.repository
              value: '{{GITHUB_REPO}}'

            # Image tags (built by docker-build.yml on label)
            - name: api.image.tag
              value: 'pr-{{number}}'
            - name: client.image.tag
              value: 'pr-{{number}}'

            # Preview domain
            - name: global.domain
              value: 'preview-pr-{{number}}.{{BASE_DOMAIN}}'

            # Lower resources for preview
            - name: api.replicaCount
              value: '1'
            - name: client.replicaCount
              value: '1'

      # Destination - preview namespace
      destination:
        server: https://kubernetes.default.svc
        namespace: 'launchpad-pr-{{number}}'

      # Sync policy - automatic
      syncPolicy:
        automated:
          prune: true # Delete resources removed from git
          selfHeal: true # Auto-sync on any changes
          allowEmpty: false

        syncOptions:
          - CreateNamespace=true # Auto-create namespace
          - PrunePropagationPolicy=foreground
          - PruneLast=true

        retry:
          limit: 3
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 1m

      # Ignore HPA-managed replicas
      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas
