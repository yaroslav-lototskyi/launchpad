name: GitOps - Trigger Argo CD Sync

on:
  push:
    branches: [main, develop]
    paths:
      - 'infra/helm/**'
      - '.github/workflows/gitops-sync.yaml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'

env:
  ARGOCD_VERSION: '2.9.3'

jobs:
  trigger-sync:
    name: Trigger Argo CD Sync
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event.inputs.environment }}" != "" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "app=launchpad-${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "app=launchpad-production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "app=launchpad-staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "app=launchpad-development" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --region us-east-1 \
            --name launchpad-${{ steps.env.outputs.environment }}

      - name: Install Argo CD CLI
        run: |
          curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd

      - name: Login to Argo CD
        run: |
          # Port-forward to Argo CD server
          kubectl port-forward svc/argocd-server -n argocd 8080:443 &
          sleep 5

          # Get admin password
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)

          # Login
          argocd login localhost:8080 \
            --username admin \
            --password $ARGOCD_PASSWORD \
            --insecure

      - name: Sync Argo CD Application
        run: |
          echo "Syncing application: ${{ steps.env.outputs.app }}"

          # Trigger sync
          argocd app sync ${{ steps.env.outputs.app }} \
            --timeout 600 \
            --prune \
            --async

          # Wait for sync (if not production)
          if [[ "${{ steps.env.outputs.environment }}" != "production" ]]; then
            argocd app wait ${{ steps.env.outputs.app }} \
              --timeout 600 \
              --health
          fi

      - name: Get sync status
        if: always()
        run: |
          argocd app get ${{ steps.env.outputs.app }}

      - name: Comment on commit
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const env = '${{ steps.env.outputs.environment }}';
            const app = '${{ steps.env.outputs.app }}';

            const comment = `## GitOps Sync Triggered\n\n` +
              `- **Environment**: ${env}\n` +
              `- **Application**: ${app}\n` +
              `- **Status**: ${context.job.status}\n\n` +
              `Check Argo CD UI for deployment status.`;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });

  notify-production:
    name: Notify Production Sync Required
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸš€ Production Deployment Ready\n\n` +
              `Changes have been merged to \`main\` branch.\n\n` +
              `**Manual Action Required**:\n` +
              `1. Review changes in Argo CD UI\n` +
              `2. Approve and sync \`launchpad-production\` application\n` +
              `3. Monitor deployment health\n\n` +
              `**Argo CD**: https://argocd.launchpad.io (or port-forward)\n\n` +
              `âš ï¸  Production deployments require manual approval.`;

            // Find the PR that was merged
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });

            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs.data[0].number,
                body: comment
              });
            }
